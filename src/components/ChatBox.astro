---
interface Props {
  scenario: any; // Using any for now to avoid extensive import cycles, or import Schema
}

const { scenario } = Astro.props;
---

<div id="chat-root" class="chat-container" data-scenario={JSON.stringify(scenario)}>
    <div class="messages-list"></div>
    <div class="options-area hidden"></div>
    <div class="continue-area hidden"></div>
</div>

<script define:vars={{ scenario }}>
    // Pass for view transitions if needed, but we use the JSON below for the class
</script>

<!-- Embedded Data for Client Rehydration -->
<script is:inline id="scenario-data" type="application/json">
    // Populated by server-side replacement or we can just use define:vars above?
    // Actually, for a class outside of .astro scope, passing via window or JSON is better.
    // Let's use the define:vars to assign to window for simplicity in this MVP.
</script>

<script>
    import { GameEngine } from '../lib/game-engine';

    // Wait for DOM
    document.addEventListener('astro:page-load', () => {
        initGame();
    });

    // Also run on immediate load (if no ViewTransitions or first load)
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initGame();
    } else {
        document.addEventListener('DOMContentLoaded', initGame);
    }

    function initGame() {
        const root = document.getElementById('chat-root');
        if (!root) return;
        if (root.getAttribute('data-loaded')) return; // Prevent double init
        
        // Get data from data-attribute (cleanest)
        const dataRaw = root.getAttribute('data-scenario');
        if (!dataRaw) return;
        
        const scenario = JSON.parse(dataRaw);
        new GameEngine(scenario, 'chat-root');
        root.setAttribute('data-loaded', 'true');
    }
</script>



<style is:global>
    :root {
        --chat-bg: #0b141a;
        --incoming-bg: #202c33;
        --outgoing-bg: #005c4b;
        --dropdown-bg: #233138;
        --text-primary: #e9edef;
        --text-secondary: #8696a0;
        --accent: #00a884;
    }

    .chat-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: var(--chat-bg);
        background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); /* WhatsApp Dark Pattern */
        background-blend-mode: overlay;
        background-repeat: repeat;
        background-size: 400px;
        position: relative;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    /* Overlay to darken background pattern */
    .chat-container::after {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(11, 20, 26, 0.95);
        pointer-events: none;
        z-index: 0;
    }

    .messages-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 5%;
        display: flex;
        flex-direction: column;
        gap: 0.5rem; /* Tighter grouping */
        position: relative;
        z-index: 1;
    }
    
    .message {
        display: flex;
        width: 100%;
        margin-bottom: 2px;
        position: relative;
        animation: slideIn 0.2s cubic-bezier(0.2, 0, 0.2, 1);
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message.kidia { 
        justify-content: flex-start; 
        padding-right: 20%;
    }
    
    .message.user { 
        justify-content: flex-end; 
        padding-left: 20%;
    }
    
    .message.system { 
        justify-content: center; 
        margin: 1rem 0;
    }
    
    /* Avatar Styles */
    .message.kidia::before {
        content: '';
        width: 35px;
        height: 35px;
        background-image: url('/kidia_explaining.png');
        background-size: 300%; /* Zoom in to face */
        background-position: 50% 8%; /* Center top where face usually is */
        background-repeat: no-repeat;
        border-radius: 50%;
        margin-right: 10px;
        align-self: flex-start;
        margin-top: 5px;
        border: 1px solid rgba(255,255,255,0.15);
        flex-shrink: 0;
        background-color: var(--incoming-bg);
    }
    
    .bubble {
        padding: 6px 10px 8px 10px; /* Adjusted padding for name */
        border-radius: 8px;
        font-size: 0.95rem;
        line-height: 1.4;
        position: relative;
        color: var(--text-primary);
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        max-width: 100%;
        word-wrap: break-word;
        min-width: 120px; /* Ensure space for name */
    }
    
    /* Sender Name Styling */
    .sender-name {
        font-size: 0.75rem;
        font-weight: bold;
        margin-bottom: 2px;
        line-height: 1.2;
    }
    
    /* Kidia Bubble (Incoming) */
    .kidia .bubble {
        background: var(--incoming-bg);
        border-top-left-radius: 0;
    }
    
    .kidia .sender-name {
        color: #ff5252; /* Distinct color for Kidia */
    }
    
    .kidia .bubble::before {
        content: "";
        position: absolute;
        top: 0;
        left: -8px;
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-top-color: var(--incoming-bg); 
        border-right-color: var(--incoming-bg); 
        border-bottom: 0;
    }
    
    /* User Bubble (Outgoing) */
    .user .bubble {
        background: var(--outgoing-bg);
        border-top-right-radius: 0;
    }
    
    .user .sender-name {
        color: #53bdeb; /* Distinct color for User */
        text-align: right;
    }
    
    .user .bubble::before {
        content: "";
        position: absolute;
        top: 0;
        right: -8px; 
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-top-color: var(--outgoing-bg);
        border-left-color: var(--outgoing-bg);
        border-bottom: 0;
    }
    
    /* System Messages */
    .system-bubble {
        background: rgba(32, 44, 51, 0.9);
        color: var(--text-secondary);
        font-size: 0.75rem;
        padding: 5px 12px;
        border-radius: 8px;
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    /* Input/Options Area */
    .options-area, .continue-area {
        background: var(--incoming-bg);
        padding: 10px 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        min-height: 60px;
        border-top: 1px solid rgba(255,255,255,0.05);
        position: relative;
        z-index: 2;
    }
    
    .options-area {
        justify-content: flex-start; /* Align response bubbles like suggestion chips */
        overflow-x: auto;
    }
    
    .continue-area {
        justify-content: center;
    }
    
    /* Response Buttons - Chip/Pill Style */
    .btn-option {
        background: #2a3942; /* Darker distinct background */
        color: var(--text-primary);
        border: 1px solid rgba(134, 150, 160, 0.3);
        padding: 8px 20px;
        border-radius: 24px; /* Full Pill */
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s, transform 0.1s;
        text-align: center;
        flex-grow: 1;
        max-width: 100%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .btn-option:hover {
        background: #364652;
    }
    
    .btn-option:active {
        background: #202c33;
        transform: scale(0.98);
    }
    
    .btn-continue {
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 24px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-continue:hover {
        background: #008f6f;
    }

    .hidden { display: none !important; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
</style>
