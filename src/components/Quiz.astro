---
interface Props {
  scenario: any;
}

const { scenario } = Astro.props;
---

<div id="quiz-container" class="quiz-container hidden" data-scenario={JSON.stringify(scenario)}>
  <div class="quiz-content">
      <h2 class="quiz-title">Test de Conocimiento <span id="q-counter" class="text-sm opacity-50"></span></h2>
      
      <!-- Intro State -->
      <div id="quiz-intro">
          <p>¬°Has terminado la misi√≥n! Ahora demuestra lo que sabes.</p>
          <button id="btn-start" class="btn-primary">Empezar Quiz</button>
          <div class="secondary-actions">
              <button id="btn-restart" class="btn-secondary">Reiniciar Misi√≥n</button>
              <button id="btn-close" class="btn-secondary">Hacer m√°s tarde</button>
          </div>
      </div>

      <!-- Question State -->
      <div id="quiz-play" class="hidden">
          <div id="quiz-question" class="question-text"></div>
          <div id="quiz-options" class="options-grid"></div>
          <div id="quiz-feedback" class="feedback hidden"></div>
          <button id="quiz-next" class="btn-primary hidden">Siguiente</button>
      </div>

      <!-- Results State -->
      <div id="quiz-results" class="hidden">
          <div class="score-circle">
              <span id="final-score">0</span>%
          </div>
          <p id="kidia-reaction" class="reaction-text"></p>
          
          <div id="badge-notification" class="hidden">
              <div class="badge-icon-animate">üèÜ</div>
              <p>¬°Has ganado la insignia <strong id="badge-name"></strong>!</p>
          </div>

          <button id="btn-finish" class="btn-primary">Volver al Mapa</button>
      </div>
  </div>
</div>

<script>
    // Elements
    const container = document.getElementById('quiz-container');
    const introEl = document.getElementById('quiz-intro');
    const playEl = document.getElementById('quiz-play');
    const resultsEl = document.getElementById('quiz-results');
    
    // Parse scenario from data attribute
    let scenario;
    try {
        scenario = JSON.parse(container.dataset.scenario);
    } catch (e) {
        console.error('[Quiz] Failed to parse scenario data', e);
    }
    
    // Play Elements
    const qCounter = document.getElementById('q-counter');
    const questionEl = document.getElementById('quiz-question');
    const optionsEl = document.getElementById('quiz-options');
    const feedbackEl = document.getElementById('quiz-feedback');
    const nextBtn = document.getElementById('quiz-next');
    
    // Result Elements
    const finalScoreEl = document.getElementById('final-score');
    const reactionEl = document.getElementById('kidia-reaction');
    
    const questions = scenario?.quiz?.questions || [];
    
    let currentIdx = 0;
    let correctCount = 0;

    // Listeners
    window.addEventListener('startQuiz', (e) => {
        // console.log('[Quiz] Event received for:', e.detail.scenarioId);
        if (scenario && e.detail.scenarioId === scenario.id) {
            container.classList.remove('hidden');
            showIntro();
        }
    });

    document.getElementById('btn-start').onclick = startQuiz;
    
    // Close / Do Later button
    const closeBtn = document.getElementById('btn-close');
    if (closeBtn) {
        closeBtn.onclick = () => {
            container.classList.add('hidden');
        };
    }

    // Restart Button Logic
    const restartBtn = document.getElementById('btn-restart');
    if (restartBtn) {
        restartBtn.onclick = () => {
            const KEY = 'kidia-progress';
            try {
                const raw = localStorage.getItem(KEY);
                if (raw) {
                    const state = JSON.parse(raw);
                    // Clear progress for this scenario
                    if (state.scenarioProgress) {
                        delete state.scenarioProgress[scenario.id];
                    }
                    // Optional: Remove from completed list if we want to force re-completion? 
                    // User just wants to restart, usually implies re-watching.
                    // But if they already completed it, maybe keep it as completed?
                    // Let's just clear the *current node* progress so it starts from beginning.
                    localStorage.setItem(KEY, JSON.stringify(state));
                }
            } catch (e) {
                console.error('Error clearing progress', e);
            }
            window.location.reload();
        };
    }

    document.getElementById('btn-finish').onclick = () => window.location.href = '/mapa';
    if(nextBtn) nextBtn.onclick = nextQuestion;

    function showIntro() {
        introEl.classList.remove('hidden');
        playEl.classList.add('hidden');
        resultsEl.classList.add('hidden');
    }

    function startQuiz() {
        currentIdx = 0;
        correctCount = 0;
        introEl.classList.add('hidden');
        playEl.classList.remove('hidden');
        renderQuestion();
    }

    function renderQuestion() {
        const q = questions[currentIdx];
        if(!q) return finishQuiz(); 

        qCounter.innerText = `(${currentIdx + 1}/${questions.length})`;
        questionEl.textContent = q.text;
        optionsEl.innerHTML = '';
        feedbackEl.className = 'feedback hidden'; 
        nextBtn.classList.add('hidden');

        q.options.forEach((text, index) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-option';
            btn.textContent = text;
            btn.onclick = () => checkAnswer(index, btn, q);
            optionsEl.appendChild(btn);
        });
    }

    function checkAnswer(index, btn, question) {
        optionsEl.querySelectorAll('button').forEach(b => b.disabled = true);

        const isCorrect = index === question.correct_index;
        
        if (isCorrect) {
            btn.classList.add('correct');
            feedbackEl.textContent = `‚úÖ ¬°Correcto! ${question.explanation}`;
            feedbackEl.classList.add('correct');
            correctCount++;
        } else {
            btn.classList.add('wrong');
            feedbackEl.textContent = `‚ùå ${question.explanation}`;
            feedbackEl.classList.add('wrong');
            
            const correctBtn = optionsEl.children[question.correct_index];
            if(correctBtn) correctBtn.classList.add('correct');
        }
        
        feedbackEl.classList.remove('hidden');
        nextBtn.classList.remove('hidden');
    }
    
    function nextQuestion() {
        currentIdx++;
        if (currentIdx < questions.length) {
            renderQuestion();
        } else {
            finishQuiz();
        }
    }

    function finishQuiz() {
        playEl.classList.add('hidden');
        resultsEl.classList.remove('hidden');
        qCounter.innerText = '';
        
        const score = Math.round((correctCount / questions.length) * 100);
        
        finalScoreEl.innerText = score.toString();
        
        // Kidia Reaction
        let reaction = "";
        if (score === 100) reaction = "¬°Incre√≠ble! üåü ¬°Eres un gur√∫ de la IA!";
        else if (score >= 70) reaction = "¬°Muy bien! üß† Ya casi lo dominas todo.";
        else reaction = "¬°Buen intento! üí™ Repasa un poco y vuelve a intentarlo.";
        
        reactionEl.innerText = reaction;

        // Save Logic
        const KEY = 'kidia-progress';
        try {
            const raw = localStorage.getItem(KEY);
            const state = raw ? JSON.parse(raw) : { 
                completedScenarios: [], 
                badges: [], 
                scores: {} 
            };
            
            state.completedScenarios = [...new Set([...state.completedScenarios || [], scenario.id])];
            state.scores = { ...(state.scores || {}), [scenario.id]: score };
            
             const badgeNotif = document.getElementById('badge-notification');
             const badgeNameEl = document.getElementById('badge-name');
             
            if (score >= 70 && scenario.badge) {
                 state.badges = [...new Set([...state.badges || [], scenario.badge.id])];
                 
                 badgeNameEl.innerText = scenario.badge.name;
                 badgeNotif.classList.remove('hidden');
                 badgeNotif.classList.add('animate-pop');
            }
            
            localStorage.setItem(KEY, JSON.stringify(state));
            
        } catch(e) {
            console.error('[Quiz] Save error', e);
        }
    }
</script>

<style>
    .quiz-container {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 1;
        transition: opacity 0.4s ease;
    }

    .quiz-container.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .quiz-content {
        background: rgba(24, 24, 27, 0.95);
        border: 1px solid rgba(34, 211, 238, 0.3);
        box-shadow: 0 0 50px rgba(34, 211, 238, 0.15);
        padding: 2.5rem;
        border-radius: 2rem;
        max-width: 550px;
        width: 90%;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    /* Decorative Gradient Blob */
    .quiz-content::before {
        content: '';
        position: absolute;
        top: -50px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 100px;
        background: var(--color-primary);
        filter: blur(80px);
        opacity: 0.2;
        pointer-events: none;
    }
    
    .quiz-title {
        font-family: 'Outfit', sans-serif;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #fff, #a5f3fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .question-text {
        font-size: 1.3rem;
        line-height: 1.6;
        margin-bottom: 2rem;
        color: #e4e4e7;
    }
    
    /* Modern Button Base */
    .btn-primary, .btn-secondary {
        font-family: 'Outfit', sans-serif;
        padding: 1rem 2rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        display: inline-block;
        margin-top: 1rem;
    }
    
    .btn-primary {
        background: var(--color-primary);
        color: #09090b;
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 0 30px rgba(34, 211, 238, 0.6);
    }

    .btn-secondary {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.8);
        margin-left: 1rem;
    }
    
    .btn-secondary:hover {
        border-color: #fff;
        background: rgba(255,255,255,0.05);
        color: #fff;
    }

    .secondary-actions {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .secondary-actions .btn-secondary {
        margin: 0; /* Override default margin */
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
    }

    .options-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 2rem 0;
    }

    .quiz-option {
        width: 100%;
        padding: 1.2rem 1.5rem;
        
        /* Premium Glass Look */
        background: rgba(255, 255, 255, 0.03); 
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        
        color: #e2e8f0;
        border-radius: 1rem; /* Softer rounded corners */
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left; /* Better for reading answers */
        font-family: 'Outfit', sans-serif;
        font-size: 1.1rem;
        position: relative;
        display: flex; /* Allow icon alignment if needed */
        align-items: center;
        gap: 1rem;
    }
    
    /* Hover Effect */
    .quiz-option:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(10px); /* Slight slide right */
        border-color: rgba(34, 211, 238, 0.5);
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.1);
    }
    
    /* Selected/Correct State */
    .quiz-option.correct {
        background: rgba(16, 185, 129, 0.2) !important;
        border-color: #10b981 !important;
        color: #fff;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
    }
    
    /* Wrong State */
    .quiz-option.wrong {
        background: rgba(239, 68, 68, 0.2) !important;
        border-color: #ef4444 !important;
        color: #fca5a5;
    }
    
    .quiz-option:disabled {
        cursor: default;
        opacity: 0.7;
    }
    
    .feedback {
        margin: 1.5rem 0;
        padding: 1rem;
        border-radius: 1rem;
        font-weight: 500;
        font-size: 0.95rem;
        animation: fadeIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }
    
    .feedback.correct { 
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.1), transparent); 
        color: #4ade80; 
        border-left: 4px solid #4ade80;
    }
    
    .feedback.wrong { 
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent); 
        color: #f87171;
        border-left: 4px solid #ef4444;
    }

    .score-circle {
        font-size: 5rem;
        font-weight: 800;
        background: linear-gradient(to bottom, var(--color-primary), var(--color-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 1rem 0;
        filter: drop-shadow(0 0 10px rgba(34, 211, 238, 0.3));
    }
    
    .hidden { display: none !important; }
    
    #badge-notification {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.05));
        border: 1px solid rgba(234, 179, 8, 0.5);
        border-radius: 1rem;
        padding: 1.5rem;
        margin: 2rem 0;
        animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .badge-icon-animate {
        font-size: 4rem;
        margin-bottom: 0.5rem;
        filter: drop-shadow(0 0 10px gold);
    }
    
    @keyframes popIn {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
