---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import ScenarioMapCard from '../components/ScenarioMapCard.astro';
import { loadScenarios } from '../lib/scenario-loader';

const scenarios = await loadScenarios('es');
console.log(`[SSR] Loaded ${scenarios.length} scenarios for Map.`);
---

<Layout title="Kidia - Mapa de Misiones">
  <Header />
  
  <main class="map-container">
    <div class="map-header">
       <div class="header-content">
           <h1 class="text-gradient title-glow">ðŸŒŒ Mapa del Conocimiento</h1>
           <p class="map-description">
               Viaja por el universo de la IA: completa cada misiÃ³n para desbloquear la siguiente.
           </p>
       </div>

       <div class="map-controls">
           <div class="global-progress tooltip-container">
               <span class="progress-label">PROGRESO GLOBAL</span>
               <div class="progress-track">
                   <div class="progress-fill" id="global-bar"></div>
                   <span id="global-percent" class="progress-text">0%</span>
               </div>
               
               <div class="tooltip-box">
                   Â¡Completa misiones para llenar la barra y convertirte en experto!
               </div>
           </div>
           
           <button id="btn-deep-mode" class="btn-deep-mode tooltip-container">
               <span class="icon">ðŸ§ </span> 
               <span class="label">MODO PROFUNDO</span>
               <span id="deep-status" class="status-indicator">OFF</span>
               
               <div class="tooltip-box tooltip-right">
                   ActÃ­valo para preguntas difÃ­ciles y desafÃ­os avanzados.
               </div>
           </button>
       </div>
    </div>
    
    <!-- Navigation Arrows -->
    <button id="scroll-left" class="nav-arrow prev" aria-label="Anterior">â€¹</button>
    <button id="scroll-right" class="nav-arrow next" aria-label="Siguiente">â€º</button>
    
    <!-- Map Grid -->
    <div class="mission-grid">
       {scenarios.map((scenario, index) => (
         <ScenarioMapCard scenario={scenario} index={index} />
       ))}
    </div>
  </main>
</Layout>

<script>
    import { ProgressService } from '../lib/progress-service';
    
    const state = ProgressService.getState();
    // Correct selector: .mission-card-v3
    const globalPercent = ProgressService.getGlobalProgress(document.querySelectorAll('.mission-card-v3').length);
    
    // 1. Update Global Stats
    const globalText = document.getElementById('global-percent');
    const globalBar = document.getElementById('global-bar');
    
    if (globalText) globalText.innerText = `${globalPercent}%`;
    if (globalBar) globalBar.style.width = `${globalPercent}%`;
    
    // 2. Hydrate Cards
    const cards = document.querySelectorAll('.mission-card-v3');
    console.log('[Map] Found cards:', cards.length);

    cards.forEach(card => {
        const id = card.getAttribute('data-id');
        const reqBadge = card.getAttribute('data-req');
        const statusText = card.querySelector('.status-text');
        
        console.log(`[Map] Checking ${id} (req: ${reqBadge})`);
        
        let isLocked = false;
        
        // Basic Lock Logic
        if (reqBadge && !state.badges.includes(reqBadge)) {
             isLocked = true;
             console.log(`[Map] ${id} LOCKED due to missing badge: ${reqBadge}`);
        }
        
        // "Intro" is always free if it's the first one or logic dictates
        if (id === 'intro-ia') {
            isLocked = false;
        }
        
        const isCompleted = state.completedScenarios.includes(id);
        
        // Apply classes
        if (isLocked) {
            card.classList.add('locked');
            card.classList.remove('available');
            if (statusText) statusText.innerText = 'ðŸ”’ Bloqueado';
        } else {
            card.classList.remove('locked');
            card.classList.add('available');
            
            if (isCompleted) {
                card.classList.add('completed');
                if (statusText) statusText.innerText = 'âœ… Completado';
            } else {
                if (statusText) statusText.innerText = 'ðŸš€ Disponible';
            }
        }
    });

    // 3. Deep Mode Logic
    const deepBtn = document.getElementById('btn-deep-mode');
    const deepStatus = document.getElementById('deep-status');
    let deepMode = localStorage.getItem('kidia_deep_mode') === 'true';
    
    function updateDeepUI() {
        deepStatus.innerText = deepMode ? 'ON' : 'OFF';
        deepBtn.classList.toggle('active', deepMode);
        document.body.classList.toggle('deep-mode-enabled', deepMode);
    }
    
    deepBtn.addEventListener('click', () => {
        deepMode = !deepMode;
        localStorage.setItem('kidia_deep_mode', deepMode);
        updateDeepUI();
    });
    
    updateDeepUI();

    // 5. Drag-to-Scroll Logic (2D: Horizontal + Vertical)
    const slider = document.querySelector('.mission-grid');
    let isDown = false;
    let startX;
    let startY;
    let scrollLeft;
    let scrollTop;
    let isDragging = false; 

    slider.addEventListener('mousedown', (e) => {
        isDown = true;
        isDragging = false;
        slider.classList.add('active');
        
        // Track Start Positions
        startX = e.pageX - slider.offsetLeft;
        startY = e.pageY - slider.offsetTop;
        
        scrollLeft = slider.scrollLeft;
        scrollTop = slider.scrollTop;
        
        // Disable snap
        slider.style.scrollSnapType = 'none';
        slider.style.cursor = 'grabbing';
    });

    window.addEventListener('mouseleave', () => {
        if(isDown) stopDrag();
    });

    window.addEventListener('mouseup', () => {
        if(isDown) stopDrag();
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        
        // Prevent default only if we are actively dragging to avoid selecting text, 
        // but since we want 2D scroll, we might want to allow some native behavior?
        // Actually, custom drag replaces native scroll. So preventDefault is correct.
        e.preventDefault();
        
        // Horizontal
        const x = e.pageX - slider.offsetLeft;
        const walkX = (x - startX) * 1.5; 
        slider.scrollLeft = scrollLeft - walkX;
        
        // Vertical
        const y = e.pageY - slider.offsetTop;
        const walkY = (y - startY) * 1.0; 
        slider.scrollTop = scrollTop - walkY;

        // Flag dragging
        if (Math.abs(walkX) > 5 || Math.abs(walkY) > 5) {
            isDragging = true;
        }
    });

    function stopDrag() {
        isDown = false;
        slider.classList.remove('active');
        slider.style.cursor = 'grab';
        
        // Re-enable snap logic
        requestAnimationFrame(() => {
            // Only horizontal snap makes sense for a reel, but we can keep it
            slider.style.scrollSnapType = 'x mandatory'; 
        });
    }

    // Prevent clicks if we were dragging
    const cardsForDrag = document.querySelectorAll('.mission-card-v3');
    cardsForDrag.forEach(card => {
        card.addEventListener('click', (e) => {
            if (isDragging) {
                e.preventDefault();
                e.stopPropagation(); // Stop navigation
                console.log('[Map] Click blocked due to drag');
            }
        }, true); // Capture phase to intercept early
    });

    // 6. Scroll Arrows Logic
    const btnLeft = document.getElementById('scroll-left');
    const btnRight = document.getElementById('scroll-right');
    
    if (btnLeft && btnRight && slider) {
        btnLeft.addEventListener('click', () => {
            slider.scrollBy({ left: -400, behavior: 'smooth' });
        });
        
        btnRight.addEventListener('click', () => {
             slider.scrollBy({ left: 400, behavior: 'smooth' });
        });
    }

    // 7. 3D Tilt Effect (Moved from Card component for better performance)
    const tiltCards = document.querySelectorAll('.mission-card-v3');
    tiltCards.forEach(card => {
        card.addEventListener('mousemove', (e) => {
            if (card.classList.contains('locked')) return;
            
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const rotateX = ((y - centerY) / centerY) * -10; // Max 10deg
            const rotateY = ((x - centerX) / centerX) * 10;
            
            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
            card.style.zIndex = '100'; // Bring to front when tilting
        });
        
        card.addEventListener('mouseleave', () => {
             card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
             card.style.zIndex = 'auto';
        });
    });
</script>

<style>
    /* Container adjustments to center the strip */
    .map-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: block; /* Removed flex centering */
        /* Deep Space Premium Gradient */
        background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
        overflow: hidden; 
    }
    
    .map-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100; /* Ensure on top */
        padding: 2rem 4rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to bottom, rgba(2, 6, 23, 0.8) 0%, transparent 100%);
        pointer-events: none; /* Let clicks pass through if needed, but controls need pointer-events: auto */
    }

    .map-header > * {
        pointer-events: auto;
    }

    .map-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        letter-spacing: -0.05em;
        text-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
    }
    
    .map-description {
        color: #94a3b8;
        margin: 0.5rem 0 0 0;
        font-size: 1rem;
        max-width: 500px;
    }

    .map-controls {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    /* Progress Bar Styled */
    .global-progress {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        position: relative; /* For tooltip */
        cursor: help;
    }
    
    /* TOOLTIPS */
    .tooltip-container {
        position: relative; /* Anchor */
    }
    
    .tooltip-box {
        position: absolute;
        top: 120%;
        right: 0;
        width: 200px;
        padding: 1rem;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 0.8rem;
        color: white;
        font-size: 0.85rem;
        line-height: 1.4;
        box-shadow: 0 10px 30px -5px rgba(0,0,0,0.5);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        pointer-events: none;
        z-index: 200;
        text-align: center;
    }
    
    .tooltip-container:hover .tooltip-box {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    /* Custom tooltip position for button */
    .tooltip-right {
        right: 0;
        top: 130%; /* Shift down slightly more */
    }

    .progress-label {
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        color: rgba(255, 255, 255, 0.5);
    }

    .progress-track {
        width: 200px;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        background: var(--color-primary);
        box-shadow: 0 0 10px var(--color-primary);
        width: 0%;
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-text {
        display: block; 
        position: absolute;
        right: 0;
        top: -1.2rem;
        font-weight: 800;
        color: var(--color-primary);
        text-shadow: 0 0 10px rgba(34, 211, 238, 0.5);
    }

    /* Deep Mode Button */
    .btn-deep-mode {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.75rem 1.5rem;
        border-radius: 99px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .btn-deep-mode:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .btn-deep-mode.active {
        border-color: var(--color-secondary);
        box-shadow: 0 0 15px rgba(232, 121, 249, 0.3);
    }

    .btn-deep-mode .status-indicator {
        font-size: 0.7rem;
        background: rgba(0,0,0,0.3);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        color: var(--color-secondary);
    }
    
    .btn-action:hover {
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
    }

    /* Carousel Grid */
    .mission-grid {
        display: flex;
        gap: 6rem;
        /* Increase top padding to avoid header overlap (approx 140px) */
        padding: 140px calc(50vw - 200px) 4rem;
        
        /* Layout */
        width: 100%;
        height: 100%; 
        
        /* Alignment */
        align-items: flex-start; /* Start from top (respecting padding) */
        
        /* Overflow - Allow 2D Scroll */
        overflow: auto; 
        
        /* Snapping */
        scroll-snap-type: x mandatory;
        
        /* Show scrollbars for debug/usability if drag fails */
        /* scrollbar-width: none; */
        /* -ms-overflow-style: none; */
        
        cursor: grab;
        /* user-select: none; */
    }

    .mission-grid.active {
        cursor: grabbing;
        scroll-behavior: auto; 
    }

    /* .mission-grid::-webkit-scrollbar { 
        display: none; 
    } */
    
    /* Ensure cards alignment */
    :global(.mission-card-v3) {
        flex: 0 0 400px;
        scroll-snap-align: center;
        /* Safe vertical centering */
        margin-top: auto;
        margin-bottom: auto;
        
        perspective: 1000px;
        position: relative;
    }

    /* Neon Connections between cards */
    :global(.mission-card-v3:not(:last-child))::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 100%; /* Start from right edge */
        width: 6rem; /* Match grid gap */
        height: 4px;
        background: linear-gradient(90deg, 
            rgba(34, 211, 238, 0.2) 0%, 
            rgba(232, 121, 249, 0.5) 50%, 
            rgba(34, 211, 238, 0.2) 100%
        );
        box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
        transform: translateY(-50%);
        opacity: 0.6;
        pointer-events: none;
        z-index: 1; /* Lift above background but below hover state/content if needed */
    }
    
    /* Connect to next card visually even if tilted */
    :global(.mission-card-v3:hover:not(:last-child))::after {
        opacity: 1;
        box-shadow: 0 0 25px rgba(232, 121, 249, 0.6);
        transition: all 0.3s ease;
    }
    
    /* Navigation Arrows */
    .nav-arrow {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 3rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 50;
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
        line-height: 0;
        padding-bottom: 0.5rem; /* Optical center adjustment */
    }
    
    .nav-arrow:hover {
        background: rgba(34, 211, 238, 0.2);
        scale: 1.1;
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
    }
    
    .nav-arrow.prev {
        left: 2rem;
    }
    
    .nav-arrow.next {
        right: 2rem;
    }
    
    @media (max-width: 768px) {
        .nav-arrow {
            width: 40px;
            height: 40px;
            font-size: 2rem;
        }
        .nav-arrow.prev { left: 1rem; }
        .nav-arrow.next { right: 1rem; }
    }
</style>
