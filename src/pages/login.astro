---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Kidia - Acceso">
  <Header />

  <main class="login-container">
    <div class="auth-card">
        <h1>Bienvenido a Kidia</h1>
        <p>Guarda tu progreso y accede a misiones premium.</p>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('login')">Entrar</button>
            <button class="tab-btn" onclick="switchTab('register')">Registrarse</button>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="auth-form">
            <input type="email" name="email" placeholder="Correo electrÃ³nico" required />
            <input type="password" name="password" placeholder="ContraseÃ±a" required />
            <button type="submit" class="btn full-width">Iniciar SesiÃ³n ðŸš€</button>
        </form>

        <!-- Register Form -->
        <form id="register-form" class="auth-form hidden">
            <input type="email" name="email" placeholder="Correo electrÃ³nico" required />
            <input type="password" name="password" placeholder="ContraseÃ±a (mÃ­n 6 carÃ¡cteres)" minlength="6" required />
            <button type="submit" class="btn full-width">Crear Cuenta âœ¨</button>
        </form>

        <div id="auth-message" class="message hidden"></div>
        
        <div class="divider">
            <span>O continÃºa con</span>
        </div>
        
        <button id="google-login" class="btn btn-secondary full-width google-btn">
            <svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(1, 0, 0, 1, 27.009001, -39.238998)"><path fill="#4285F4" d="M -3.264 51.509 C -3.264 50.719 -3.334 49.969 -3.454 49.239 L -14.754 49.239 L -14.754 53.749 L -8.284 53.749 C -8.574 55.229 -9.424 56.479 -10.684 57.329 L -10.684 60.329 L -6.824 60.329 C -4.564 58.239 -3.264 55.159 -3.264 51.509 Z"/><path fill="#34A853" d="M -14.754 63.239 C -11.514 63.239 -8.804 62.159 -6.824 60.329 L -10.684 57.329 C -11.764 58.049 -13.134 58.489 -14.754 58.489 C -17.884 58.489 -20.534 56.379 -21.484 53.529 L -25.464 53.529 L -25.464 56.619 C -23.494 60.539 -19.424 63.239 -14.754 63.239 Z"/><path fill="#FBBC05" d="M -21.484 53.529 C -21.734 52.809 -21.864 52.039 -21.864 51.239 C -21.864 50.439 -21.724 49.669 -21.484 48.949 L -21.484 45.859 L -25.464 45.859 C -26.284 47.479 -26.754 49.299 -26.754 51.239 C -26.754 53.179 -26.284 54.999 -25.464 56.619 L -21.484 53.529 Z"/><path fill="#EA4335" d="M -14.754 43.989 C -12.984 43.989 -11.354 44.599 -10.104 45.789 L -6.744 42.429 C -8.804 40.509 -11.514 39.239 -14.754 39.239 C -19.424 39.239 -23.494 41.939 -25.464 45.859 L -21.484 48.949 C -20.534 46.099 -17.884 43.989 -14.754 43.989 Z"/></g></svg>
            Google
        </button>
    </div>
  </main>
</Layout>

<script is:inline>
    function switchTab(tab) {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const tabs = document.querySelectorAll('.tab-btn');
        const msg = document.getElementById('auth-message');
        
        msg.classList.add('hidden');

        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
        }
    }
</script>

<script>
    import { supabase } from '../lib/supabase';

    const loginForm = document.getElementById('login-form') as HTMLFormElement;
    const registerForm = document.getElementById('register-form') as HTMLFormElement;
    const googleBtn = document.getElementById('google-login');
    const msg = document.getElementById('auth-message');

    function showMessage(text, type = 'error') {
        msg.textContent = text;
        msg.className = `message ${type}`;
        msg.classList.remove('hidden');
    }

    loginForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(loginForm);
        const { error } = await supabase.auth.signInWithPassword({
            email: formData.get('email') as string,
            password: formData.get('password') as string,
        });

        if (error) showMessage(error.message);
        else window.location.href = '/mapa';
    });

    registerForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(registerForm);
        const { error } = await supabase.auth.signUp({
            email: formData.get('email') as string,
            password: formData.get('password') as string,
        });

        if (error) showMessage(error.message);
        else showMessage('Â¡Cuenta creada! Revisa tu email para confirmar.', 'success');
    });

    googleBtn?.addEventListener('click', async () => {
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: `${window.location.origin}/auth/callback`
            }
        });
        if (error) showMessage(error.message);
    });
</script>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 80px);
        padding: 2rem;
    }

    .auth-card {
        background: var(--color-surface);
        padding: 2.5rem;
        border-radius: 1.5rem;
        border: 1px solid rgba(255,255,255,0.1);
        width: 100%;
        max-width: 400px;
        text-align: center;
        backdrop-filter: blur(20px);
    }

    h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(to right, var(--color-primary), var(--color-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    p {
        color: #a1a1aa;
        margin-bottom: 2rem;
    }

    .tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 1rem;
    }

    .tab-btn {
        flex: 1;
        background: none;
        border: none;
        color: #888;
        font-weight: 600;
        padding: 0.5rem;
        cursor: pointer;
        transition: color 0.2s;
    }

    .tab-btn.active {
        color: var(--color-text);
        border-bottom: 2px solid var(--color-primary);
        margin-bottom: -1rem; /* Overlap border */
        padding-bottom: 1rem;
    }

    .auth-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    input {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        font-family: inherit;
    }

    input:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    .full-width {
        width: 100%;
        margin-top: 1rem;
    }

    .message {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
    }

    .message.error {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }

    .message.success {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
    }

    .hidden {
        display: none;
    }
    
    .divider {
        margin: 2rem 0;
        position: relative;
        display: flex;
        justify-content: center;
    }
    
    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 1px;
        background: rgba(255,255,255,0.1);
        z-index: 0;
    }
    
    .divider span {
        background: var(--color-surface);
        padding: 0 1rem;
        color: #888;
        font-size: 0.9rem;
        z-index: 1;
    }
    
    .google-btn {
        display: flex;
        gap: 0.8rem;
        align-items: center;
    }
</style>
